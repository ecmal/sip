{
  "version": 3,
  "file": "outgoing.js",
  "sourceRoot": "/Users/Sergey/Work/GH/ecmal/sip/src",
  "sources": [
    "outgoing.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import {Call, CallState, CallDirection} from \"./call\";\nimport {Station} from \"../../station\";\nimport {Request} from \"../../models/message/request\";\nimport {Response} from \"../../models/message/response\";\nimport {MediaServer} from \"../../media/server\";\nimport {InviteDialog} from \"./dialog\";\nimport {Sequence} from \"../../models/common/sequence\";\nimport {Mime} from \"../../models/common/mime\";\nimport {Sdp} from \"../../models/common/sdp\";\n\nexport class OutgoingInviteDialog extends InviteDialog {\n\n    constructor(station:Station,request:Request){\n        super(station, new Call({\n            id          : request.callId,\n            direction   : CallDirection.OUTGOING,\n            from        : request.from,\n            to          : request.to\n        }));\n        this.onResponse = this.onResponse.bind(this);\n        this.onRequest = this.onRequest.bind(this);\n        this.init(request)\n    }\n\n    protected onResponse(message:Response){\n        if(message.status == 100){\n            this.call.emit('trying');\n        } else\n        if(message.status == 180){\n            this.call.emit('ringing');\n        } else\n        if(message.status == 200){\n            if(message.sequence.method==\"INVITE\"){\n                MediaServer.talkTo(this.call,new Sdp(message.content));\n                this.call.emit('accept');\n                this.sendAck(message);\n            }\n        } else {\n            this.call.emit('reject');\n            this.done();\n            message.print()\n        }\n    }\n    protected onRequest(message:Request){\n        if(message.method==\"ACK\"){\n            this.onAck(message)\n        }else\n        if(message.method==\"BYE\"){\n            this.onBye(message)\n        } else\n        if(message.method==\"INVITE\"){\n            this.onInvite(message);\n        } else\n        if(message.method==\"CANCEL\"){\n            this.onCancel(message)\n        }\n    }\n    protected onAck(request:Request){\n        if(request.contentLength>0) {\n            MediaServer.talkTo(this.call,new Sdp(request.content));\n        }\n        //console.info(\"GOT ACK\");\n    }\n    protected onBye(request:Request){\n        this.sendByeAccept(request)\n    }\n    protected onInvite(request:Request){\n        if(request.contentLength>0) {\n            MediaServer.talkTo(this.call,new Sdp(request.content));\n        }\n        this.sendInviteAccept(request);\n    }\n    protected onCancel(request:Request){\n        this.sendCancelAccept(request)\n    }\n\n    protected sendByeAccept(message:Request){\n        this.station.transport.send(new Response({\n            status      :200,\n            message     :'OK',\n            via         :message.vias,\n            from        :message.from,\n            to          :message.to,\n            sequence    :message.sequence,\n            callId      :message.callId,\n        }));\n        this.call.emit(\"bye\");\n        this.done();\n    }\n    protected sendCancelAccept(message:Request){\n        var response = new Response({\n            status          : '200',\n            message         : 'Ok',\n            via             : message.vias,\n            from            : message.from,\n            to              : message.to,\n            sequence        : message.sequence,\n            callId          : message.callId,\n            contentLength   : 0\n        });\n        this.station.transport.send(response);\n    }\n    protected sendAck(response:Response){\n        this.station.transport.send(new Request({\n            method          : \"ACK\",\n            uri             : response.contact.uri,\n            from            : response.from,\n            to              : response.to,\n            callId          : response.callId,\n            maxForwards     : 70,\n            sequence        : new Sequence({\n                method      : \"ACK\",\n                value       : 1\n            }),\n            route           : response.recordRoute?response.recordRoute:undefined\n        }))\n    }\n    protected sendBye(){\n        this.call.state=CallState.ENDED;\n        var from,to;\n        if(this.call.from.uri.username==this.station.contact.uri.username){\n            from = this.call.from;\n            to = this.call.to;\n        }else{\n            from = this.call.to;\n            to = this.call.from;\n        }\n        var request = new Request({\n            method          : \"BYE\",\n            uri             : to.uri,\n            from            : from,\n            to              : to,\n            callId          : this.call.id,\n            sequence        : new Sequence({\n                method      : \"BYE\",\n                value       : 1\n            })\n        });\n        request.setHeader(\"Max-Forwards\",70);\n        request.contentLength = 0;\n        this.call.emit('bye');\n        this.done();\n        this.station.transport.send(request);\n    }\n    protected sendInvite(){\n        this.station.transport.send(new Request({\n            method          : \"INVITE\",\n            sequence        : new Sequence({\n                method      : \"INVITE\",\n                value       : 1\n            }),\n            uri             : this.call.to.uri,\n            callId          : this.call.id,\n            from            : this.call.from,\n            to              : this.call.to,\n            supported       : ['outbound', 'replaces', 'join'],\n            maxForwards     : 70,\n            contentType     : Mime.SDP,\n            content         : new Buffer(MediaServer.listenTo(this.call).toString())\n        }))\n    }\n    protected sendInviteAccept(message:Request){\n        this.call.emit(\"update\");\n        var response = new Response({\n            status      : 200,\n            message     : 'OK',\n            via         : message.vias,\n            from        : message.from,\n            to          : message.to,\n            sequence    : message.sequence,\n            callId      : message.callId,\n            contentType : new Mime({\n                type        : 'application',\n                subtype     : 'sdp'\n            }),\n            content     : new Buffer(this.call.localSdp.toString())\n        });\n        this.station.transport.send(response);\n    }\n    protected init(request:Request){\n        this.station.transport.on(`response:${this.call.id}`,this.onResponse);\n        this.station.transport.on(`request:${this.call.id}`,this.onRequest);\n        this.station.emit('call',this.call);\n        this.call.once('drop',()=>{\n            this.sendBye()\n        });\n        this.emit('init');\n        this.sendInvite();\n    }\n    protected done(){\n        if(this.call.remoteSdp) {\n            var sdp = this.call.remoteSdp;\n            delete this.call.remoteSdp;\n            delete this.call.localSdp;\n            this.call.emit(Call.EVENTS.AUDIO.STOP,\n                sdp.audio.port,\n                sdp.connection.connectionAddress,\n                0,\n                '0.0.0.0'\n            );\n        }\n        this.station.transport.off(`response:${this.call.id}`,this.onResponse);\n        this.station.transport.off(`request:${this.call.id}`,this.onRequest);\n        this.call.emit('done');\n        this.emit('done');\n    }\n}\n\n\n\n\n"
  ]
}