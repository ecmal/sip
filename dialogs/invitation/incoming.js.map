{
  "version": 3,
  "file": "incoming.js",
  "sourceRoot": "/Users/Sergey/Work/GH/ecmal/sip/src",
  "sources": [
    "incoming.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import {Call, CallState, CallDirection} from \"./call\";\nimport {Station} from \"../../station\";\nimport {Request} from \"../../models/message/request\";\nimport {Response} from \"../../models/message/response\";\nimport {MediaServer} from \"../../media/server\";\nimport {InviteDialog} from \"./dialog\";\nimport {Sequence} from \"../../models/common/sequence\";\nimport {Mime} from \"../../models/common/mime\";\nimport {Sdp} from \"../../models/common/sdp\";\n\nexport class IncomingInviteDialog extends InviteDialog {\n    private request:Request;\n    constructor(station:Station,request:Request){\n        super(station,new Call({\n            id          : request.callId,\n            direction   : CallDirection.INCOMING,\n            from        : request.from,\n            to          : request.to\n        }));\n        MediaServer.listenTo(this.call);\n        this.onResponse = this.onResponse.bind(this);\n        this.onRequest = this.onRequest.bind(this);\n        this.init(this.request=request)\n    }\n\n    protected onResponse(message:Response){\n        if(message.status == 100){\n            this.call.state = CallState.TRYING;\n            this.station.emit('invite',this.call);\n        } else\n        if(message.status == 180){\n            this.call.state = CallState.RINGING;\n            this.station.emit('dialing',this.call);\n        } else\n        if(message.status == 200){\n            if(message.sequence.method==\"INVITE\"){\n                // todo cleanup\n                this.call.state = CallState.TALKING;\n                this.station.emit('call',this.call);\n                var sdp = message.content.toString();\n                //this.media.remotePort = parseInt(sdp.match(/m=audio\\s+(\\d+)/)[1]);\n                //this.media.remoteAddress = sdp.match(/c=IN\\s+IP4\\s+(\\d+\\.\\d+.\\d+\\.\\d+)/)[1];\n                //this.media.enabled = true;\n                //console.info(`Send Media To ${this.media.remoteAddress}:${this.media.remotePort}`);\n                this.sendAck(message);\n            }\n        } else {\n            //this.station.emit('bye',this.call);\n        }\n    }\n    protected onRequest(message:Request){\n        if(message.method==\"ACK\"){\n            this.onAck(message)\n        }else\n        if(message.method==\"BYE\"){\n            this.onBye(message)\n        } else\n        if(message.method==\"INVITE\"){\n            this.onInvite(message);\n        } else\n        if(message.method==\"CANCEL\"){\n            this.onCancel(message)\n        }\n    }\n    protected sendAck(response:Response){\n        this.station.transport.send(new Request({\n            method          : \"ACK\",\n            uri             : response.contact.uri,\n            from            : response.from,\n            to              : response.to,\n            callId          : response.callId,\n            maxForwards     : 70,\n            sequence        : new Sequence({\n                method      : \"ACK\",\n                value       : 1\n            })\n        }))\n    }\n    protected onAck(request:Request){\n        //request.print();\n        if(request.contentLength>0) {\n            MediaServer.talkTo(this.call,new Sdp(request.content));\n        }\n    }\n    protected onBye(request:Request){\n        this.sendByeAccept(request)\n    }\n    protected onInvite(request:Request){\n        if(request.contentLength>0) {\n            MediaServer.talkTo(this.call,new Sdp(request.content));\n        }\n        this.sendUpdateAccept(request);\n    }\n    protected onCancel(request:Request){\n        this.sendCancelAccept(request)\n    }\n    protected sendBye(){\n        this.call.state=CallState.ENDED;\n        var from,to;\n        if(this.call.from.uri.username==this.station.contact.uri.username){\n            from = this.call.from;\n            to = this.call.to;\n        }else{\n            from = this.call.to;\n            to = this.call.from;\n        }\n        var request = new Request({\n            method          : \"BYE\",\n            uri             : this.request.contact.uri,\n            from            : from,\n            to              : to,\n            callId          : this.call.id,\n            sequence        : new Sequence({\n                method      : \"BYE\",\n                value       : 1\n            })\n        });\n        request.setHeader(\"Route\",this.request.getHeader(\"Record-Route\"));\n        request.setHeader(\"Max-Forwards\",70);\n        request.contentLength = 0;\n        this.emit(\"bye\");\n        this.done();\n        this.station.transport.send(request);\n    }\n    protected sendByeAccept(message:Request){\n        this.station.transport.send(new Response({\n            status      :200,\n            message     :'OK',\n            via         :message.vias,\n            from        :message.from,\n            to          :message.to,\n            sequence    :message.sequence,\n            callId      :message.callId,\n        }));\n        this.emit('bye');\n        this.done();\n    }\n    protected sendCancelAccept(message:Request){\n        var response = new Response({\n            status          : '200',\n            message         : 'Ok',\n            via             : message.vias,\n            from            : message.from,\n            to              : message.to,\n            sequence        : message.sequence,\n            callId          : message.callId,\n            contentLength   : 0\n        });\n        this.station.transport.send(response);\n        this.emit('cancel');\n        this.done()\n    }\n    protected sendUpdateAccept(message:Request){\n        var response = new Response({\n            status      : 200,\n            message     : 'OK',\n            via         : message.vias,\n            from        : message.from,\n            to          : message.to,\n            sequence    : message.sequence,\n            callId      : message.callId,\n            contentType : Mime.SDP,\n            content     : new Buffer(this.call.localSdp.toString())\n        });\n        this.emit('update');\n        this.station.transport.send(response);\n    }\n    protected sendInviteAccept(message:Request){\n        var response = new Response({\n            status      : 200,\n            message     : 'OK',\n            via         : message.vias,\n            from        : message.from,\n            to          : message.to,\n            sequence    : message.sequence,\n            callId      : message.callId,\n            contentType : Mime.SDP,\n            content     : new Buffer(MediaServer.listenTo(this.call).toString())\n        });\n        this.emit('accept');\n        this.station.transport.send(response);\n    }\n    protected sendInviteReject(message:Request){\n        var response = new Response({\n            status      : 603,\n            message     : 'Decline',\n            via         : message.vias,\n            from        : message.from,\n            to          : message.to,\n            sequence    : message.sequence,\n            callId      : message.callId\n        });\n        this.emit('reject');\n        this.done();\n        this.station.transport.send(response);\n    }\n    protected sendInviteTrying(message:Request){\n        var response = new Response({\n            status      : 100,\n            message     : 'Trying',\n            via         : message.vias,\n            from        : message.from,\n            to          : message.to,\n            sequence    : message.sequence,\n            callId      : message.callId\n        });\n        this.emit('trying');\n        this.station.transport.send(response);\n    }\n    protected sendInviteRinging(message:Request){\n        var response = new Response({\n            status      : 180,\n            message     : 'Ringing',\n            via         : message.vias,\n            from        : message.from,\n            to          : message.to,\n            sequence    : message.sequence,\n            callId      : message.callId\n        });\n        this.emit('ringing');\n        this.station.transport.send(response);\n    }\n\n    protected init(request:Request){\n        this.station.transport.on(`response:${this.call.id}`,this.onResponse);\n        this.station.transport.on(`request:${this.call.id}`,this.onRequest);\n        var onTake = ()=>{\n            this.call.off('take',onTake);\n            this.call.off('drop',onDrop);\n            this.sendInviteAccept(request);\n            this.call.once('drop',()=>{\n                this.sendBye();\n            })\n        };\n        var onDrop = ()=>{\n            this.call.off('take',onTake);\n            this.call.off('drop',onDrop);\n            this.sendInviteReject(request);\n        };\n        this.call.on('take',onTake);\n        this.call.on('drop',onDrop);\n\n        this.station.emit('call',this.call);\n        this.emit('init');\n        this.sendInviteTrying(request);\n        this.sendInviteRinging(request);\n    }\n    protected done(){\n        this.call.off('drop');\n        if(this.call.remoteSdp){\n            var sdp = this.call.remoteSdp;\n            //delete this.call.remoteSdp;\n            //delete this.call.localSdp;\n            this.call.emit(Call.EVENTS.AUDIO.STOP,\n                sdp.audio.port,\n                sdp.connection.connectionAddress,\n                0,'0.0.0.0'\n            );\n        }\n        this.station.transport.off(`response:${this.call.id}`,this.onResponse);\n        this.station.transport.off(`request:${this.call.id}`,this.onRequest);\n        this.emit('done');\n    }\n    public emit(event,...args){\n        this.call.emit(event,...args);\n        super.emit(event,...args);\n\n    }\n}\n\n\n\n\n\n"
  ]
}